- name: Start ngrok TCP 22 (FINAL FIX)
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          set +e

          if [ -z "${NGROK_AUTH_TOKEN}" ]; then
            echo "ERROR: NGROK_AUTH_TOKEN secret kosong!"
            exit 1
          fi

          ngrok config add-authtoken "${NGROK_AUTH_TOKEN}"

          # Start ngrok (TANPA --web-addr)
          nohup ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
          NGROK_PID=$!

          echo "Ngrok PID: $NGROK_PID"
          sleep 3

          echo "== CHECK NGROK PROCESS =="
          ps -p $NGROK_PID >/dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "NGROK CRASH. Log:"
            tail -n 200 ngrok.log
            exit 1
          fi

          echo "== WAIT NGROK API 4040 =="
          OK=0
          for i in {1..30}; do
            curl -s http://127.0.0.1:4040/api/tunnels >/dev/null 2>&1
            if [ $? -eq 0 ]; then
              OK=1
              break
            fi
            sleep 1
          done

          if [ $OK -ne 1 ]; then
            echo "Ngrok API 4040 tidak bisa diakses"
            tail -n 200 ngrok.log
            exit 1
          fi

          echo "================ NGROK TUNNEL ================"
          curl -s http://127.0.0.1:4040/api/tunnels | sed 's/\\n/\n/g'
          echo "=============================================="

          echo ""
          echo "LOGIN SSH:"
          echo "ssh runner@<HOST> -p <PORT>"
